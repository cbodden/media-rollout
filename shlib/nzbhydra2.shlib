readonly _NH_HOME="/home/hydra/.nzbhydra2_data"

function _nzbhydra2()
{
    local _NH_LOCAL="/opt/nzbhydra2"
    mkdir ${_NH_LOCAL}
    cd ${_NH_LOCAL}

    local _NH_ADDY="https://github.com/theotherp/nzbhydra2/releases"

    local _NH_VER="$(curl -s ${_NH_ADDY}/latest \
        | cut -d\" -f2 \
        | awk -F 'tag/' '{print $2}' )"

    local _NH_TAG="${_NH_ADDY}/tag/${_NH_VER}"

    local _NH_RLS="$(curl -s ${_NH_ADDY}/tag/${_NH_VER} \
        | grep linux \
        | head -n 1 \
        | cut -d\" -f2 \
        | awk -F "${_NH_VER}/" '{print $2}' )"

    wget ${_NH_ADDY}/download/${_NH_VER}/${_NH_RLS} -O /opt/nzbhydra2/${_NH_RLS}

    unzip ${_NH_RLS}
    rm ${_NH_RLS}

    cp systemd/nzbhydra2.service /lib/systemd/system/nzbhydra2.service
    dos2unix /lib/systemd/system/nzbhydra2.service

    sed -i "s|^WorkingDirectory=.*|WorkingDirectory=${_NH_LOCAL}|g" /lib/systemd/system/nzbhydra2.service
    sed -i 's/^User=ubuntu.*/User=hydra/' /lib/systemd/system/nzbhydra2.service
    sed -i 's/^Group=vboxsf.*/Group=hydra/' /lib/systemd/system/nzbhydra2.service
    sed -i 's/^ExecStart=\/home\/nzbhydra\/nzbhydra2\/nzbhydra2 --nobrowser.*/ExecStart=\/usr\/bin\/python \/opt\/nzbhydra2\/nzbhydra2wrapper.py --nobrowser --datafolder \/home\/hydra\/.nzbhydra2_data/' /lib/systemd/system/nzbhydra2.service

    chown -R hydra:hydra /opt/nzbhydra2/
    systemctl daemon-reload
    systemctl enable nzbhydra2.service
}

function _nzbhydra2_configure()
{
    cp ${PROGDIR}/config_files/nzbhydra.yml ${_NH_HOME}/

    systemctl start nzbhydra2.service
    sleep 5
    systemctl stop nzbhydra2.service

    local _SAB_API=$(cat ${_SAB_HOME}/sabnzbd.ini \
        | awk '/^api_key/ {print $3}')

    rm -rf ${_NH_HOME}/*

    cat ${PROGDIR}/config_files/nzbhydra.yml \
        | sed "s/RM_SH/${_IP}/g" \
        | sed "s/RM_SP/8080/g" \
        | sed "s/RM_SA/${_SAB_API}/g" \
        | sed "s/RM_NH/${_IP}/g" \
        | sed "s/RM_NP/5076/g" \
        >> ${_NH_HOME}/nzbhydra.yml

        ##| sed "s/RM_NA/${_NH_API}/g" \

    chown -R hydra:hydra ${_NH_HOME}
    systemctl start nzbhydra2.service
}
