readonly _LL_HOME="/home/lazylibrarian/.lazylibrarian"

function _lazylibrarian()
{
    cd /opt/
    git clone https://github.com/DobyTang/LazyLibrarian.git
    chown -R lazylibrarian:lazylibrarian /opt/LazyLibrarian/
    cp LazyLibrarian/init/lazylibrarian.default /etc/default/lazylibrarian
    sed -i 's/RUN_AS=$USER.*/RUN_AS=lazylibrarian/' /etc/default/lazylibrarian
    cp LazyLibrarian/init/lazylibrarian.initd /etc/init.d/lazylibrarian

    chown -R lazylibrarian:downloads /${_PATH}/books
    chmod a+x /etc/init.d/lazylibrarian
    update-rc.d lazylibrarian defaults
}

function _lazylibrarian_configure()
{
    systemctl start lazylibrarian.service
    sleep 5
    systemctl stop lazylibrarian.service

    local _SAB_API=$(cat ${_SAB_HOME}/sabnzbd.ini \
        | awk '/^api_key/ {print $3}')

    local _NH_API=$(yq read ${_NH_HOME}/nzbhydra.yml main.apiKey)

    rm -rf ${_LL_HOME}/*

    cat ${PROGDIR}/config_files/lazylibrarian.ini \
        | sed "s/RM_SH/${_IP}/g" \
        | sed "s/RM_SP/8080/g" \
        | sed "s/RM_SA/${_SAB_API}/g" \
        | sed "s/RM_NH/${_IP}/g" \
        | sed "s/RM_NP/5076/g" \
        | sed "s/RM_NA/${_NH_API}/g" \
        >> ${_LL_HOME}/config.ini

    chown -R lazylibrarian:lazylibrarian ${_LL_HOME}
    systemctl start lazylibrarian.service
}
